@startuml Class Diagram

title PasswordManager Class Diagram

class Main {
  +main(args: String[]): void
  +displayBanner(console: Console): void
  +initializeVault(console: Console): boolean
  +createNewVault(console: Console): boolean
  +unlockExistingVault(console: Console): boolean
  +registerFeatures(registry: FeatureRegistry): void
}

interface Feature {
  +getId(): String
  +getDisplayName(): String
  +getDescription(): String
  +requiresUnlockedVault(): boolean
  +isEnabled(): boolean
  +execute(console: Console): void
  +getCategory(): FeatureCategory
  +getSortOrder(): int
}

enum FeatureCategory {
  ENCRYPTION
  FILE_MANAGEMENT
  PASSWORD_MANAGEMENT
  SETTINGS
  SYSTEM
  OTHER
}

class AbstractFeature {
  #vaultSession: VaultSession
  +AbstractFeature(vaultSession: VaultSession)
  +{abstract} getId(): String
  +{abstract} getDisplayName(): String
  +{abstract} getDescription(): String
  +{abstract} execute(console: Console): void
}

class FeatureRegistry {
  -features: Map<String, Feature>
  +register(feature: Feature): void
  +unregister(featureId: String): void
  +getFeatureById(featureId: String): Feature
  +getAllFeatures(): List<Feature>
  +getEnabledFeatures(): List<Feature>
  +getEnabledFeaturesInCategory(category: FeatureCategory): List<Feature>
  +getFeaturesByCategory(): Map<FeatureCategory, List<Feature>>
  +getFeatureCount(): int
  +getEnabledFeatureCount(): int
  +hasFeature(featureId: String): boolean
  +clear(): void
}

class FeatureMenu {
  -registry: FeatureRegistry
  -vaultSession: VaultSession
  -console: Console
  +FeatureMenu(registry: FeatureRegistry, vaultSession: VaultSession, console: Console)
  +run(): void
  +displayMenu(): void
  +executeFeature(feature: Feature): void
}

class EncryptDataFeature {
  +EncryptDataFeature(vaultSession: VaultSession)
  +getId(): String
  +getDisplayName(): String
  +getDescription(): String
  +requiresUnlockedVault(): boolean
  +isEnabled(): boolean
  +execute(console: Console): void
  +getCategory(): FeatureCategory
}

class DecryptDataFeature {
  +DecryptDataFeature(vaultSession: VaultSession)
  +getId(): String
  +getDisplayName(): String
  +getDescription(): String
  +requiresUnlockedVault(): boolean
  +isEnabled(): boolean
  +execute(console: Console): void
  +getCategory(): FeatureCategory
}

class EncryptFileFeature implements Feature {
  +getId(): String
  +getDisplayName(): String
  +getDescription(): String
  +requiresUnlockedVault(): boolean
  +isEnabled(): boolean
  +getCategory(): FeatureCategory
  +getSortOrder(): int
  +execute(console: Console): void
}

class DecryptFileFeature implements Feature {
  +getId(): String
  +getDisplayName(): String
  +getDescription(): String
  +requiresUnlockedVault(): boolean
  +isEnabled(): boolean
  +getCategory(): FeatureCategory
  +getSortOrder(): int
  +execute(console: Console): void
}

class LockVaultFeature {
  +LockVaultFeature(vaultSession: VaultSession)
  +getId(): String
  +getDisplayName(): String
  +getDescription(): String
  +requiresUnlockedVault(): boolean
  +isEnabled(): boolean
  +execute(console: Console): void
  +getCategory(): FeatureCategory
}

class ExitFeature {
  +ExitFeature(vaultSession: VaultSession)
  +getId(): String
  +getDisplayName(): String
  +getDescription(): String
  +requiresUnlockedVault(): boolean
  +isEnabled(): boolean
  +execute(console: Console): void
  +getCategory(): FeatureCategory
}

class HashedPassword {
  -algorithm: String
  -iterations: int
  -salt: String
  -hash: String
  +HashedPassword(algorithm: String, iterations: int, salt: String, hash: String)
  +getAlgorithm(): String
  +getIterations(): int
  +getSalt(): String
  +getHash(): String
}

class PBKDF2Hasher {
  -ALGORITHM: String = "PBKDF2WithHmacSHA256"
  -KEY_LENGTH_BITS: int = 256
  -DEFAULT_ITERATIONS: int = 600_000
  -SALT_LENGTH_BYTES: int = 16
  +generateSalt(): byte[]
  +hashPassword(password: char[], salt: byte[], iterations: int): HashedPassword
  +defaultHashPassword(password: char[]): HashedPassword
  +verifyPassword(password: char[], stored: HashedPassword): boolean
  +deriveSessionKey(password: char[], stored: HashedPassword): byte[]
}

class VaultStorage {
  -vaultFolder: Path
  -masterKeyFile: Path
  +exists(): boolean
  +saveMasterKey(algorithm: String, iterations: int, salt: String, hash: String): void
  +loadMasterKey(): String
  +loadHashedPassword(): HashedPassword
}

class VaultSession {
  -unlocked: boolean
  -vaultSessionKey: SecretKey
  +unlock(keyBytes: byte[]): void
  +lock(): void
  +isUnlocked(): boolean
  +getVaultSessionKey(): SecretKey
}

class PasswordValidator {
  +validate(masterKeyChars: char[]): ValidationResult
}

class ValidationResult {
  -ok: boolean
  -messages: List<String>
  +ValidationResult(ok: boolean, messages: List<String>)
  +ok(): boolean
  +messages(): List<String>
}

interface EncryptionProvider {
  +encrypt(data: byte[], key: SecretKey): EncryptionResult
  +decrypt(data: byte[], key: SecretKey): byte[]
}

class AesGcmProvider {
  +encrypt(data: byte[], key: SecretKey): EncryptionResult
  +decrypt(data: byte[], key: SecretKey): byte[]
}

class EncryptionResult {
  -encryptedData: byte[]
  -iv: byte[]
  +EncryptionResult(encryptedData: byte[], iv: byte[])
  +getEncryptedData(): byte[]
  +getIv(): byte[]
}

class SecurityProfile {
  -encryptionProvider: EncryptionProvider
  +SecurityProfile(encryptionProvider: EncryptionProvider)
  +getEncryptionProvider(): EncryptionProvider
}

class FileEncryptor {
  +encryptFile(file: File, outputFile: File, key: SecretKey): void
  +encryptFileWithProgress(file: File, outputFile: File, key: SecretKey, callback: ProgressCallback): boolean
}

class FileDecryptor {
  +decryptFile(inputFile: File, outputFile: File, sessionKey: SecretKey): boolean
  +decryptFileWithProgress(inputFile: File, outputFile: File, sessionKey: SecretKey, callback: ProgressCallback): boolean
  +verifyFile(inputFile: File, sessionKey: SecretKey): boolean
}

class EncryptedFileFormat {
  +isEncryptedFile(file: File): boolean
  +readHeader(in: InputStream): FileMetadata
  +writeHeader(out: OutputStream, profile: SecurityProfile, iv: byte[]): void
}

class CryptoDemo {
  +main(args: String[]): void
}

class FileEncryptionDemo {
  +main(args: String[]): void
}

class VaultSecurityTest {
  +testVaultSecurity(): void
}

Main --> FeatureRegistry : creates
Main --> FeatureMenu : creates
Main --> HashedPassword : uses
Main --> PBKDF2Hasher : uses
Main --> VaultStorage : uses
Main --> VaultSession : uses
Main --> PasswordValidator : uses
Main --> ValidationResult : uses

FeatureRegistry --> Feature : manages
Feature --> FeatureCategory : uses
Feature --> VaultSession : uses

AbstractFeature --> Feature : implements
AbstractFeature --> VaultSession : uses

EncryptDataFeature --> AbstractFeature : extends
DecryptDataFeature --> AbstractFeature : extends
LockVaultFeature --> AbstractFeature : extends
ExitFeature --> AbstractFeature : extends

EncryptFileFeature --> Feature : implements
DecryptFileFeature --> Feature : implements

FeatureMenu --> FeatureRegistry : uses
FeatureMenu --> Feature : executes
FeatureMenu --> VaultSession : uses

PBKDF2Hasher --> HashedPassword : creates
VaultStorage --> HashedPassword : uses
PasswordValidator --> ValidationResult : returns

EncryptionProvider --> EncryptionResult : returns
AesGcmProvider --> EncryptionProvider : implements
SecurityProfile --> EncryptionProvider : uses

EncryptDataFeature --> EncryptionProvider : uses
DecryptDataFeature --> EncryptionProvider : uses

@enduml
